apiVersion: apps/v1
kind: Deployment
metadata:
  name: mastodon
  namespace: mstdn-soine-site
  labels:
    app: mastodon
spec:
  selector:
    matchLabels:
      app: mastodon
  replicas: 2
  template:
    metadata:
      labels:
        app: mastodon
    spec:
      dnsConfig:
        searches:
          - svc.cluster.local
          - cluster.local
        options:
          - name: single-request-reopen
          - name: use-vc
          - name: ndots
            value: "2"
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  app: cloudflare-tunnel
              topologyKey: "kubernetes.io/hostname"
      containers:
        - name: web
          image: ghcr.io/mastodon/mastodon:v4.4.7
          command: [
            "bash",
            "-c",
            "rm -f /mastodon/tmp/pids/server.pid; bundle exec rails s -p 3000",
          ]
          envFrom:
            - configMapRef:
                name: env
          ports:
            - containerPort: 3000
              name: mastodon
          volumeMounts:
            - mountPath: /utils
              readOnly: true
              name: mstdn-utils
        - name: sidekiq
          image: ghcr.io/mastodon/mastodon:v4.4.7
          command: ["bash", "-c", "bundle exec sidekiq -c 25"]
          envFrom:
            - configMapRef:
                name: env
          env:
            - name: RES_OPTIONS
              value: "single-request-reopen use-vc"
            - name: RUBYOPT
              value: "-rresolv-replace"
          volumeMounts:
            - mountPath: /utils
              readOnly: true
              name: mstdn-utils
        - name: streaming
          image: ghcr.io/mastodon/mastodon-streaming:v4.4.7
          command: ["node", "./streaming/index.js"]
          envFrom:
            - configMapRef:
                name: env
          ports:
            - containerPort: 4000
              name: streaming
          volumeMounts:
            - mountPath: /utils
              readOnly: true
              name: mstdn-utils
        - name: nginx
          image: nginx
          ports:
            - containerPort: 80
              name: nginx
          volumeMounts:
            - mountPath: /etc/nginx
              readOnly: true
              name: nginx-conf
      volumes:
        - name: nginx-conf
          configMap:
            name: nginx-conf
            items:
              - key: nginx.conf
                path: nginx.conf
              - key: virtualhost.conf
                path: virtualhost/virtualhost.conf
        - name: mstdn-utils
          configMap:
            name: mstdn-utils
            items:
              - key: rename.rb
                path: rename.rb
      restartPolicy: Always
